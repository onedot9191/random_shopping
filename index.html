<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëœë¤ ìš©ëˆìœ¼ë¡œ ë¬¼ê±´ ì‚¬ê¸°</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ì‚¬ìš©ì ì •ì˜ ìŠ¤íƒ€ì¼ */
        body {
            font-family: 'Inter', sans-serif;
        }
        .priority-selected {
            background-color: #3b82f6; /* blue-500 */
            color: white;
        }
        .alert-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000; /* Ensure it's above other elements */
            display: none;
            min-width: 250px; /* Min width for better readability */
            text-align: center;
        }
        .alert-success {
            background-color: #10b981; /* emerald-500 */
            color: white;
        }
        .alert-error {
            background-color: #ef4444; /* red-500 */
            color: white;
        }
        .alert-info {
            background-color: #3b82f6; /* blue-500 */
            color: white;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        textarea {
            resize: vertical; /* Allow vertical resize only */
        }
        .summary-item {
            margin-bottom: 0.5rem; /* 8px */
        }
        .spin-result {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            margin: 0.25rem;
            background-color: #e0e7ff; /* indigo-100 */
            border-radius: 0.25rem;
            font-weight: 500;
        }
        /* ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ ìŠ¤íƒ€ì¼ */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: #3b82f6; /* blue-500 */
            animation: spin 1s ease-in-out infinite;
            margin-left: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .money-animation span {
            display: inline-block;
            animation: quickChange 0.1s linear infinite;
        }
        @keyframes quickChange {
            0%   { opacity: 0.8; transform: translateY(-2px); }
            25%  { opacity: 1; transform: translateY(0px); }
            50%  { opacity: 0.8; transform: translateY(2px); }
            75%  { opacity: 1; transform: translateY(0px); }
            100% { opacity: 0.8; transform: translateY(-2px); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- ì•Œë¦¼ ë©”ì‹œì§€ ì˜ì—­ -->
    <div id="alertMessage" class="alert-message"></div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-indigo-600">ğŸ ëœë¤ ìš©ëˆìœ¼ë¡œ ë¬¼ê±´ ì‚¬ê¸° ğŸ</h1>
        </header>

        <!-- Step 1 & 2: Setup Phase -->
        <div id="setupPhase" class="bg-white p-6 rounded-lg shadow mb-8">
            <!-- Step 1: What do you want to buy? -->
            <div id="step1DesiredItemSection" class="mb-6">
                <label for="desiredItemInput" class="block text-xl font-semibold mb-3 text-indigo-500">1. ë¬´ì—‡ì„ ê°€ì¥ ì‚¬ê³  ì‹¶ë‚˜ìš”?</label>
                <input type="text" id="desiredItemInput" placeholder="ì‚¬ê³  ì‹¶ì€ ê²ƒì„ ì…ë ¥í•˜ì„¸ìš”..." class="w-full p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                <button id="confirmDesiredItemButton" class="mt-4 w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition-colors" disabled>ë‹¤ìŒìœ¼ë¡œ</button>
            </div>

            <!-- Step 2: Get Pocket Money -->
            <div id="step2PocketMoneySection" class="mb-6 hidden">
                 <h2 class="text-xl font-semibold mb-3 text-indigo-500">2. ì˜¤ëŠ˜ì˜ ìš©ëˆ í™•ì¸í•˜ê¸°! (ì´ 3ë²ˆ ë½‘ê¸°)</h2>
                <div class="p-4 bg-indigo-50 rounded-lg mb-4">
                    <div class="flex flex-col sm:flex-row items-center justify-between mb-2 gap-2">
                        <span class="text-lg">ë‚˜ì˜ ìš©ëˆ:</span>
                        <span id="pocketMoneyDisplay" class="text-2xl font-bold text-indigo-700">0ì›</span>
                    </div>
                    <div id="spinResultsContainer" class="text-sm text-gray-600 min-h-[24px]">
                        <!-- ê° ë½‘ê¸° ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. -->
                    </div>
                     <div id="currentSpinAnimationContainer" class="text-center my-2 min-h-[30px]">
                        <!-- í˜„ì¬ ë½‘ê¸° ì• ë‹ˆë©”ì´ì…˜ ì˜ì—­ -->
                    </div>
                </div>
                <button id="getPocketMoneyButton" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition-colors mb-2 sm:mb-0 sm:mr-2">
                    ğŸ’¸ ìš©ëˆ ë½‘ê¸°! (ë‚¨ì€ íšŸìˆ˜: <span id="spinsLeftCount">3</span>)
                </button>
                <button id="proceedToShoppingButton" class="w-full sm:w-auto bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md transition-colors hidden">ğŸ›ï¸ ì„ ë¬¼ ê³ ë¥´ëŸ¬ ê°€ê¸°</button>
            </div>
        </div>

        <!-- Step 3: Shopping Phase (Initially Hidden) -->
        <div id="shoppingPhase" class="hidden">
            <div class="mb-8 p-4 bg-green-50 rounded-lg shadow text-center">
                <p class="text-lg mb-1">ë‚´ê°€ ê°–ê³  ì‹¶ì€ ê²ƒ: <strong id="displayDesiredItem" class="text-green-700"></strong></p>
                <p class="text-lg">ì˜¤ëŠ˜ì˜ ìš©ëˆ: <strong id="displayShoppingPhasePocketMoney" class="text-green-700"></strong></p>
            </div>

            <!-- ê¸°ì¤€ ì„ íƒ -->
            <div class="mb-8 p-4 bg-white rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-3 text-indigo-500">ìš°ì„  ìˆœìœ„ ì„ íƒ:</h2>
                <div id="prioritySelection" class="flex flex-wrap gap-2 sm:gap-4">
                    <button data-priority="balanced" class="priority-btn flex-grow sm:flex-none px-4 py-2 border border-gray-300 rounded-md hover:bg-indigo-100 transition-colors priority-selected">ê· í˜•</button>
                    <button data-priority="design" class="priority-btn flex-grow sm:flex-none px-4 py-2 border border-gray-300 rounded-md hover:bg-indigo-100 transition-colors">ë””ìì¸ ì¤‘ì‹œ</button>
                    <button data-priority="practicality" class="priority-btn flex-grow sm:flex-none px-4 py-2 border border-gray-300 rounded-md hover:bg-indigo-100 transition-colors">ì‹¤ìš©ì„± ì¤‘ì‹œ</button>
                </div>
            </div>

            <div class="lg:flex lg:gap-8">
                <!-- ìƒí’ˆ ëª©ë¡ -->
                <div class="lg:w-2/3">
                    <h2 class="text-2xl font-semibold mb-6 text-indigo-500">ì„ ë¬¼ ëª©ë¡ ğŸ›ï¸</h2>
                    <div id="giftList" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
                        <!-- ìƒí’ˆ ì¹´ë“œê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. (ì´ë¯¸ì§€ ì—†ìŒ) -->
                    </div>
                </div>

                <!-- ì¥ë°”êµ¬ë‹ˆ -->
                <div class="lg:w-1/3 mt-8 lg:mt-0">
                    <div class="bg-white p-6 rounded-lg shadow sticky top-8">
                        <h2 class="text-2xl font-semibold mb-6 text-indigo-500">ì¥ë°”êµ¬ë‹ˆ ğŸ›’</h2>
                        <div id="cartItems" class="mb-6 min-h-[100px] max-h-[300px] overflow-y-auto pr-2">
                            <p id="emptyCartMessage" class="text-gray-500">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-lg font-semibold">ì´ ê¸ˆì•¡:</span>
                                <span id="cartTotal" class="text-xl font-bold text-indigo-600">0ì›</span>
                            </div>
                            <button id="checkoutButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md transition-colors disabled:opacity-50" disabled>
                                ì‡¼í•‘ ê²°ê³¼ ë³´ê¸°
                            </button>
                             <button id="resetAppButtonFromShopping" class="mt-4 w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition-colors">ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Reason Phase (Initially Hidden) -->
        <div id="reasonPhase" class="hidden bg-white p-6 rounded-lg shadow mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-500">ğŸ“ ì‡¼í•‘ í›„ê¸° ì‘ì„± ğŸ“</h2>
            <div id="purchaseResultSummary" class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-md text-yellow-700">
                <!-- êµ¬ë§¤ ê²°ê³¼ ìš”ì•½ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. -->
            </div>
            <div class="mb-4">
                <label for="reasonInput" class="block text-lg font-medium mb-2 text-gray-700">ì›í•˜ëŠ” ë¬¼ê±´ì„ ëª¨ë‘ êµ¬ë§¤í–ˆë‚˜ìš”? ì•„ë‹ˆë¼ë©´ ê·¸ ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€ìš”?</label>
                <textarea id="reasonInput" rows="4" class="w-full p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>
            </div>
            <button id="submitReasonButton" class="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition-colors">ìµœì¢… ìš”ì•½ ë³´ê¸°</button>
        </div>

        <!-- Step 5: Final Summary Phase (Initially Hidden) -->
        <div id="finalSummaryPhase" class="hidden bg-white p-6 rounded-lg shadow mb-8">
            <h2 class="text-2xl font-semibold mb-6 text-center text-indigo-500">ğŸ‰ ì˜¤ëŠ˜ì˜ ì‡¼í•‘ ìµœì¢… ìš”ì•½ ğŸ‰</h2>
            <div class="space-y-3 text-gray-700">
                <p class="summary-item"><strong>ì²˜ìŒì— ê°–ê³  ì‹¶ì—ˆë˜ ê²ƒ:</strong> <span id="finalDesiredItem" class="font-medium text-indigo-600"></span></p>
                <p class="summary-item"><strong>ë½‘ì€ ìš©ëˆ:</strong> <span id="finalInitialPocketMoney" class="font-medium text-indigo-600"></span></p>
                <p class="summary-item"><strong>ì„ íƒí•œ ìƒí’ˆ ì´ì•¡:</strong> <span id="finalTotalCost" class="font-medium text-indigo-600"></span></p>
                <p class="summary-item"><strong>ë‚¨ì€ ìš©ëˆ (ë˜ëŠ” ë¶€ì¡± ê¸ˆì•¡):</strong> <span id="finalRemainingPocketMoney" class="font-medium"></span></p> <!-- ìƒ‰ìƒ ë™ì  ë³€ê²½ -->
                <div id="finalUserReasonContainer" class="summary-item">
                    <p><strong>ë‚˜ì˜ ì‡¼í•‘ í›„ê¸°:</strong></p>
                    <p id="finalUserReason" class="mt-1 p-3 bg-gray-50 border border-gray-200 rounded-md whitespace-pre-wrap"></p>
                </div>
            </div>
            <button id="restartAppButton" class="mt-8 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-md transition-colors">ë‹¤ì‹œ í•˜ê¸°</button>
        </div>


         <footer class="text-center mt-12 py-6 border-t border-gray-300">
            <p class="text-gray-600">&copy; 2024 ëœë¤ ìš©ëˆìœ¼ë¡œ ë¬¼ê±´ ì‚¬ê¸°. ëª¨ë“  ê¶Œë¦¬ ë³´ìœ .</p>
        </footer>
    </div>

    <script>
        // --- ë°ì´í„° ì •ì˜ ---
        const giftsData = [
            { id: 1, name: "ìŠ¤í‹°ì»¤ ì„¸íŠ¸", price: 3000, design: 5, practicality: 2 },
            { id: 2, name: "ìºë¦­í„° ì–‘ë§", price: 5000, design: 4, practicality: 4 },
            { id: 3, name: "ë¯¸ë‹ˆë©€ íŒ”ì°Œ", price: 7000, design: 4, practicality: 3 },
            { id: 4, name: "ê·€ì—¬ìš´ í”¼ê·œì–´", price: 8000, design: 5, practicality: 1 },
            { id: 5, name: "ê³ ê¸‰ ìƒ¤í”„íœìŠ¬", price: 9000, design: 3, practicality: 5 },
            { id: 6, name: "ë¯¸ë‹ˆ í…€ë¸”ëŸ¬", price: 10000, design: 3, practicality: 5 },
            { id: 7, name: "í–¥ê¸°ë¡œìš´ í•¸ë“œí¬ë¦¼", price: 6000, design: 4, practicality: 4 },
            { id: 8, name: "ì»¤í”Œ í‚¤ë§", price: 8500, design: 5, practicality: 3 },
            { id: 9, name: "ë‹¤ìœ¡ì´ í™”ë¶„", price: 7500, design: 4, practicality: 2 },
            { id: 10, name: "ë””ìì¸ ì±…ê°ˆí”¼", price: 4000, design: 5, practicality: 3 }
        ];

        let cart = [];
        let currentSortCriterion = 'balanced';
        let desiredItemText = '';
        let initialPocketMoney = 0; 
        let currentPocketMoney = 0; 
        let finalUserReasonText = ''; 
        
        let spinCount = 0; 
        const spinsNeeded = 3; 
        let accumulatedSpinMoney = 0; 
        const singleSpinAmounts = [1000, 2000, 3000, 4000, 5000];


        // --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
        const setupPhaseDiv = document.getElementById('setupPhase');
        const shoppingPhaseDiv = document.getElementById('shoppingPhase');
        const reasonPhaseDiv = document.getElementById('reasonPhase');
        const finalSummaryPhaseDiv = document.getElementById('finalSummaryPhase'); 


        const step1DesiredItemSection = document.getElementById('step1DesiredItemSection');
        const desiredItemInput = document.getElementById('desiredItemInput');
        const confirmDesiredItemButton = document.getElementById('confirmDesiredItemButton');
        
        const step2PocketMoneySection = document.getElementById('step2PocketMoneySection');
        const pocketMoneyDisplay = document.getElementById('pocketMoneyDisplay'); 
        const getPocketMoneyButton = document.getElementById('getPocketMoneyButton');
        const proceedToShoppingButton = document.getElementById('proceedToShoppingButton');
        const spinResultsContainerElement = document.getElementById('spinResultsContainer'); 
        const currentSpinAnimationContainer = document.getElementById('currentSpinAnimationContainer');


        const displayDesiredItem = document.getElementById('displayDesiredItem');
        const displayShoppingPhasePocketMoney = document.getElementById('displayShoppingPhasePocketMoney'); 
        
        const giftListElement = document.getElementById('giftList');
        const cartItemsElement = document.getElementById('cartItems');
        const cartTotalElement = document.getElementById('cartTotal');
        const checkoutButton = document.getElementById('checkoutButton');
        const emptyCartMessage = document.getElementById('emptyCartMessage');
        const prioritySelectionDiv = document.getElementById('prioritySelection');
        const alertMessageElement = document.getElementById('alertMessage');
        const resetAppButtonFromShopping = document.getElementById('resetAppButtonFromShopping');

        const purchaseResultSummaryElement = document.getElementById('purchaseResultSummary');
        const reasonInput = document.getElementById('reasonInput');
        const submitReasonButton = document.getElementById('submitReasonButton');

        const finalDesiredItemElem = document.getElementById('finalDesiredItem');
        const finalInitialPocketMoneyElem = document.getElementById('finalInitialPocketMoney');
        const finalTotalCostElem = document.getElementById('finalTotalCost');
        const finalRemainingPocketMoneyElem = document.getElementById('finalRemainingPocketMoney');
        const finalUserReasonContainerElem = document.getElementById('finalUserReasonContainer');
        const finalUserReasonElem = document.getElementById('finalUserReason');
        const restartAppButton = document.getElementById('restartAppButton');


        // --- ì•Œë¦¼ ë©”ì‹œì§€ í•¨ìˆ˜ ---
        function showAlert(message, type = 'success', duration = 3000) {
            alertMessageElement.textContent = message;
            alertMessageElement.className = `alert-message alert-${type}`; 
            alertMessageElement.style.display = 'block';
            setTimeout(() => {
                alertMessageElement.style.display = 'none';
            }, duration);
        }

        // --- UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
        function updatePocketMoneyDisplayElements() {
            const formattedPocketMoney = `${initialPocketMoney.toLocaleString()}ì›`;
            pocketMoneyDisplay.textContent = formattedPocketMoney; 
            displayShoppingPhasePocketMoney.textContent = formattedPocketMoney; 
        }
        
        // --- ìƒí’ˆ ë Œë”ë§ í•¨ìˆ˜ (ì´ë¯¸ì§€ ì œê±°) ---
        function renderGifts() {
            let sortedGifts = [...giftsData]; 
            if (currentSortCriterion === 'design') {
                sortedGifts.sort((a, b) => b.design - a.design || a.price - b.price);
            } else if (currentSortCriterion === 'practicality') {
                sortedGifts.sort((a, b) => b.practicality - a.practicality || a.price - b.price);
            } else { 
                sortedGifts.sort((a, b) => (b.design + b.practicality) - (a.design + a.practicality) || a.price - b.price);
            }

            giftListElement.innerHTML = ''; 
            sortedGifts.forEach(gift => {
                const card = `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden flex flex-col">
                        <div class="p-4 flex flex-col flex-grow">
                            <h3 class="text-lg font-semibold mb-2 text-gray-800">${gift.name}</h3>
                            <p class="text-indigo-600 font-bold text-xl mb-2">${gift.price.toLocaleString()}ì›</p>
                            <div class="text-sm text-gray-600 mb-1">
                                <span>ë””ìì¸:</span>
                                <span class="font-medium">${'â­'.repeat(gift.design)}${'â˜†'.repeat(5-gift.design)} (${gift.design}/5)</span>
                            </div>
                            <div class="text-sm text-gray-600 mb-3">
                                <span>ì‹¤ìš©ì„±:</span>
                                <span class="font-medium">${'ğŸŒŸ'.repeat(gift.practicality)}${'â˜†'.repeat(5-gift.practicality)} (${gift.practicality}/5)</span>
                            </div>
                            <button data-id="${gift.id}" class="add-to-cart-btn mt-auto w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-3 rounded-md transition-colors text-sm">
                                ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€
                            </button>
                        </div>
                    </div>
                `;
                giftListElement.insertAdjacentHTML('beforeend', card);
            });
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', () => addToCart(parseInt(button.dataset.id)));
            });
        }

        // --- ì¥ë°”êµ¬ë‹ˆ ë Œë”ë§ í•¨ìˆ˜ ---
        function renderCart() {
            cartItemsElement.innerHTML = '';
            if (cart.length === 0) {
                emptyCartMessage.style.display = 'block';
                checkoutButton.disabled = true;
            } else {
                emptyCartMessage.style.display = 'none';
                cart.forEach(item => {
                    const cartItemHTML = `
                        <div class="flex justify-between items-center py-2 border-b border-gray-200 last:border-b-0">
                            <div>
                                <p class="font-medium text-gray-700">${item.name} (x${item.quantity})</p>
                                <p class="text-sm text-gray-500">${(item.price * item.quantity).toLocaleString()}ì›</p>
                            </div>
                            <button data-id="${item.id}" class="remove-from-cart-btn text-red-500 hover:text-red-700 font-semibold text-sm">ì‚­ì œ</button>
                        </div>
                    `;
                    cartItemsElement.insertAdjacentHTML('beforeend', cartItemHTML);
                });
                checkoutButton.disabled = false;
            }
            document.querySelectorAll('.remove-from-cart-btn').forEach(button => {
                button.addEventListener('click', () => removeFromCart(parseInt(button.dataset.id)));
            });
            updateCartTotal();
        }

        // --- ì¥ë°”êµ¬ë‹ˆ ì´ì•¡ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
        function updateCartTotal() {
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            cartTotalElement.textContent = `${total.toLocaleString()}ì›`;
        }

        // --- ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆ ì¶”ê°€ í•¨ìˆ˜ ---
        function addToCart(giftId) {
            const gift = giftsData.find(g => g.id === giftId);
            if (!gift) return;

            const existingItem = cart.find(item => item.id === giftId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({ ...gift, quantity: 1 });
            }
            showAlert(`${gift.name} ìƒí’ˆì„ ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.`, 'success');
            renderCart();
        }
        
        // --- ì¥ë°”êµ¬ë‹ˆì—ì„œ ìƒí’ˆ ì œê±° í•¨ìˆ˜ ---
        function removeFromCart(giftId) {
            const itemIndex = cart.findIndex(item => item.id === giftId);
            if (itemIndex > -1) {
                const item = cart[itemIndex];
                showAlert(`${item.name} ìƒí’ˆì„ ì¥ë°”êµ¬ë‹ˆì—ì„œ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.`, 'success'); 
                if (item.quantity > 1) {
                    item.quantity--;
                } else {
                    cart.splice(itemIndex, 1);
                }
                renderCart();
            }
        }
        
        // --- êµ¬ë§¤ ì‹œë„ ë° ì´ìœ  ì‘ì„± í˜ì´ì§€ë¡œ ì´ë™ í•¨ìˆ˜ ---
        function proceedToReasonPhase() {
            if (cart.length === 0) {
                showAlert("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ìƒí’ˆì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.", 'error');
                return; 
            }
            const totalCost = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let summaryHTML = '';

            if (totalCost > initialPocketMoney) {
                showAlert(`ì˜ˆì‚° ë¶€ì¡±! ${initialPocketMoney.toLocaleString()}ì›ì˜ ìš©ëˆìœ¼ë¡œëŠ” ${totalCost.toLocaleString()}ì› ì–´ì¹˜ì˜ ìƒí’ˆì„ êµ¬ë§¤í•  ìˆ˜ ì—†ì–´ìš”. ğŸ˜¥ ì¥ë°”êµ¬ë‹ˆë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”.`, 'error', 5000);
                return; 
            } else {
                currentPocketMoney = initialPocketMoney - totalCost; 
                summaryHTML = `
                    <p><strong>êµ¬ë§¤ ê²°ê³¼:</strong> ì„±ê³µ! ğŸ‰</p>
                    <p>ì´ ${totalCost.toLocaleString()}ì› ì–´ì¹˜ì˜ ìƒí’ˆì„ êµ¬ë§¤í•˜ì…¨ìŠµë‹ˆë‹¤.</p>
                    <p>êµ¬ë§¤ í›„ ë‚¨ì€ ìš©ëˆì€ ${currentPocketMoney.toLocaleString()}ì› ì…ë‹ˆë‹¤.</p>
                `;
                 showAlert("êµ¬ë§¤ ì™„ë£Œ! ì‡¼í•‘ í›„ê¸°ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.", "success", 4000);

                purchaseResultSummaryElement.innerHTML = summaryHTML;
            
                shoppingPhaseDiv.style.display = 'none';
                reasonPhaseDiv.style.display = 'block';
                reasonInput.value = ''; 
                reasonInput.focus();
            }
        }

        // --- ìµœì¢… ìš”ì•½ í˜ì´ì§€ í‘œì‹œ í•¨ìˆ˜ ---
        function showFinalSummary() {
            finalUserReasonText = reasonInput.value.trim();

            finalDesiredItemElem.textContent = desiredItemText || "ì…ë ¥í•˜ì§€ ì•ŠìŒ";
            finalInitialPocketMoneyElem.textContent = `${initialPocketMoney.toLocaleString()}ì›`;
            
            const totalCartCost = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            finalTotalCostElem.textContent = `${totalCartCost.toLocaleString()}ì›`;

            if (totalCartCost <= initialPocketMoney) { 
                 finalRemainingPocketMoneyElem.textContent = `${currentPocketMoney.toLocaleString()}ì› ë‚¨ìŒ`;
                 finalRemainingPocketMoneyElem.className = "font-medium text-green-600";
            } else { 
                const shortage = totalCartCost - initialPocketMoney;
                finalRemainingPocketMoneyElem.textContent = `${shortage.toLocaleString()}ì› ë¶€ì¡±`;
                finalRemainingPocketMoneyElem.className = "font-medium text-red-600";
            }

            if (finalUserReasonText) {
                finalUserReasonElem.textContent = finalUserReasonText;
                finalUserReasonContainerElem.style.display = 'block';
            } else {
                finalUserReasonElem.textContent = "ì…ë ¥í•˜ì§€ ì•ŠìŒ";
            }
            
            reasonPhaseDiv.style.display = 'none';
            finalSummaryPhaseDiv.style.display = 'block';
            showAlert("ì˜¤ëŠ˜ì˜ ì‡¼í•‘ í™œë™ì´ ëª¨ë‘ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!", "info", 4000);
            window.scrollTo(0, 0);
        }


        // --- ì•± ì´ˆê¸°í™” / ë¦¬ì…‹ í•¨ìˆ˜ ---
        function resetApplication() {
            cart = [];
            currentSortCriterion = 'balanced';
            desiredItemText = '';
            initialPocketMoney = 0;
            currentPocketMoney = 0;
            finalUserReasonText = '';
            spinCount = 0;
            accumulatedSpinMoney = 0;

            desiredItemInput.value = '';
            confirmDesiredItemButton.disabled = true;
            
            pocketMoneyDisplay.textContent = "0ì›"; 
            displayShoppingPhasePocketMoney.textContent = "0ì›";
            spinResultsContainerElement.innerHTML = ''; 
            currentSpinAnimationContainer.innerHTML = ''; 

            step1DesiredItemSection.style.display = 'block';
            step2PocketMoneySection.style.display = 'none';
            getPocketMoneyButton.innerHTML = `ğŸ’¸ ìš©ëˆ ë½‘ê¸°! (ë‚¨ì€ íšŸìˆ˜: <span id="spinsLeftCount">${spinsNeeded}</span>)`; 
            getPocketMoneyButton.disabled = false; 
            getPocketMoneyButton.style.display = 'inline-block';
            proceedToShoppingButton.style.display = 'none'; 

            setupPhaseDiv.style.display = 'block';
            shoppingPhaseDiv.style.display = 'none'; 
            reasonPhaseDiv.style.display = 'none'; 
            finalSummaryPhaseDiv.style.display = 'none'; 
            reasonInput.value = '';

            prioritySelectionDiv.querySelectorAll('.priority-btn').forEach(btn => {
                 btn.classList.remove('priority-selected');
            });
            const balancedButton = prioritySelectionDiv.querySelector('.priority-btn[data-priority="balanced"]');
            if (balancedButton) {
                balancedButton.classList.add('priority-selected');
            }
            // showAlert("ëª¨ë“  ë‚´ìš©ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”!", "info"); // DOMContentLoadedì—ì„œ í˜¸ì¶œ ì‹œ ë©”ì‹œì§€ ì•ˆ ëœ¨ê²Œ
            window.scrollTo(0, 0); 
        }

        // --- ìš©ëˆ ë½‘ê¸° ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜ ---
        function runSpinAnimation(callback) {
            getPocketMoneyButton.disabled = true;
            getPocketMoneyButton.innerHTML = `ëŒë¦¬ëŠ” ì¤‘... <div class="spinner inline-block"></div>`;
            currentSpinAnimationContainer.innerHTML = `<span class="text-2xl font-bold text-indigo-500 money-animation"><span>${Math.floor(Math.random()*5000)}</span>ì›</span>`;
            
            let animationInterval = setInterval(() => {
                 currentSpinAnimationContainer.innerHTML = `<span class="text-2xl font-bold text-indigo-500 money-animation"><span>${Math.floor(Math.random()*5000)}</span>ì›</span>`;
            }, 100);

            setTimeout(() => {
                clearInterval(animationInterval);
                currentSpinAnimationContainer.innerHTML = ''; 
                callback(); 
            }, 1000); 
        }


        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
        desiredItemInput.addEventListener('input', () => {
            confirmDesiredItemButton.disabled = desiredItemInput.value.trim() === '';
        });

        confirmDesiredItemButton.addEventListener('click', () => {
            desiredItemText = desiredItemInput.value.trim();
            if (desiredItemText === "") { 
                showAlert("ë¬´ì—‡ì„ ì‚¬ê³  ì‹¶ì€ì§€ ì…ë ¥í•´ì£¼ì„¸ìš”!", "error");
                return;
            }
            displayDesiredItem.textContent = desiredItemText || "íŠ¹ë³„í•œ ê²ƒ"; 
            
            step1DesiredItemSection.style.display = 'none';
            step2PocketMoneySection.style.display = 'block';
            
            spinResultsContainerElement.innerHTML = ''; 
            currentSpinAnimationContainer.innerHTML = '';
            accumulatedSpinMoney = 0; 
            spinCount = 0; 
            pocketMoneyDisplay.textContent = "0ì›"; 
            getPocketMoneyButton.innerHTML = `ğŸ’¸ ìš©ëˆ ë½‘ê¸°! (ë‚¨ì€ íšŸìˆ˜: <span id="spinsLeftCount">${spinsNeeded}</span>)`;
            getPocketMoneyButton.disabled = false; 
            getPocketMoneyButton.style.display = 'inline-block';
            proceedToShoppingButton.style.display = 'none'; 
            showAlert("ì¢‹ì•„ìš”! ì´ì œ ìš©ëˆì„ í™•ì¸í•´ë³¼ê¹Œìš”?", "success");
        });

        getPocketMoneyButton.addEventListener('click', () => {
            if (spinCount < spinsNeeded) {
                runSpinAnimation(() => {
                    spinCount++; 
                    const currentSpinAmount = singleSpinAmounts[Math.floor(Math.random() * singleSpinAmounts.length)];
                    accumulatedSpinMoney += currentSpinAmount;
                    
                    const spinResultHTML = `<span class="spin-result">${spinCount}ë²ˆì§¸: ${currentSpinAmount.toLocaleString()}ì›</span>`;
                    spinResultsContainerElement.insertAdjacentHTML('beforeend', spinResultHTML);
                    
                    pocketMoneyDisplay.textContent = `${accumulatedSpinMoney.toLocaleString()}ì› (ëˆ„ì )`;
                    
                    const remainingSpins = spinsNeeded - spinCount;
                    const spinsLeftCountSpan = document.getElementById('spinsLeftCount');
                    if(spinsLeftCountSpan) {
                       spinsLeftCountSpan.textContent = remainingSpins;
                    }
                    getPocketMoneyButton.innerHTML = `ğŸ’¸ ìš©ëˆ ë½‘ê¸°! (ë‚¨ì€ íšŸìˆ˜: <span id="spinsLeftCount">${remainingSpins}</span>)`;

                    if (spinCount === spinsNeeded) {
                        initialPocketMoney = accumulatedSpinMoney;
                        currentPocketMoney = initialPocketMoney; 
                        updatePocketMoneyDisplayElements(); 
                        
                        getPocketMoneyButton.disabled = true; 
                        proceedToShoppingButton.style.display = 'inline-block';
                        showAlert(`ì´ ${spinsNeeded}ë²ˆì˜ ë½‘ê¸° ì™„ë£Œ! ì˜¤ëŠ˜ì˜ ì´ ìš©ëˆì€ ${initialPocketMoney.toLocaleString()}ì› ì…ë‹ˆë‹¤!`, 'success', 4000);
                    } else {
                         showAlert(`${spinCount}ë²ˆì§¸ ë½‘ê¸°: ${currentSpinAmount.toLocaleString()}ì›!`, 'info');
                         getPocketMoneyButton.disabled = false; 
                    }
                });
            }
        });

        proceedToShoppingButton.addEventListener('click', () => {
            if (initialPocketMoney <= 0 && desiredItemText === '') { 
                 showAlert("ë¨¼ì € ì‚¬ê³  ì‹¶ì€ ê²ƒì„ ì ê³  ìš©ëˆì„ ë°›ì•„ì£¼ì„¸ìš”!", "error");
                 resetApplication(); 
                 return;
            }
             if (spinCount < spinsNeeded) { 
                showAlert(`ìš©ëˆ ë½‘ê¸°ë¥¼ ${spinsNeeded - spinCount}ë²ˆ ë” ì§„í–‰í•´ì£¼ì„¸ìš”!`, "error");
                return;
            }
            setupPhaseDiv.style.display = 'none';
            shoppingPhaseDiv.style.display = 'block';
            reasonPhaseDiv.style.display = 'none'; 
            finalSummaryPhaseDiv.style.display = 'none';
            renderGifts();
            renderCart();
        });
        
        prioritySelectionDiv.addEventListener('click', (event) => {
            if (event.target.classList.contains('priority-btn')) {
                currentSortCriterion = event.target.dataset.priority;
                prioritySelectionDiv.querySelectorAll('.priority-btn').forEach(btn => {
                    btn.classList.remove('priority-selected');
                });
                event.target.classList.add('priority-selected');
                renderGifts();
            }
        });

        checkoutButton.addEventListener('click', proceedToReasonPhase);
        resetAppButtonFromShopping.addEventListener('click', resetApplication);

        submitReasonButton.addEventListener('click', showFinalSummary); 
        restartAppButton.addEventListener('click', resetApplication); 


        // --- ì´ˆê¸°í™” ---
        document.addEventListener('DOMContentLoaded', () => {
            resetApplication(); 
             // DOMContentLoadedì—ì„œë§Œ íŠ¹ë³„íˆ ì´ˆê¸° ë©”ì‹œì§€ í‘œì‹œ
            showAlert("í™˜ì˜í•©ë‹ˆë‹¤! ì‚¬ê³  ì‹¶ì€ ê²ƒì„ ì ê³  ìš©ëˆì„ ë½‘ì•„ë³´ì„¸ìš”.", "info", 4000);
        });
    </script>
</body>
</html>
